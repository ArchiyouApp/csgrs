name: Rust CI

on: [push, pull_request]

jobs:
  check:
    name: Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Rust/Cargo Cache
        uses: Swatinem/rust-cache@v2
        
      - name: Run Check f32 single threaded earcut
        run: cargo check --no-default-features --features
          "f32 earcut stl-io svg-io dxf-io truetype-text hershey-text image-io"
        
      - name: Run Check f32 parallel earcut
        run: cargo check --no-default-features --features
          "f32 earcut parallel stl-io svg-io dxf-io truetype-text hershey-text image-io"
          
      - name: Run Check f32 single threaded delaunay
        run: cargo check --no-default-features --features
          "f32 delaunay stl-io svg-io dxf-io truetype-text hershey-text image-io"
        
      - name: Run Check f32 parallel delaunay
        run: cargo check --no-default-features --features
          "f32 delaunay parallel stl-io svg-io dxf-io truetype-text hershey-text image-io"
          
      - name: Run Check f64 single threaded earcut
        run: cargo check --no-default-features --features
          "f64 earcut stl-io svg-io dxf-io truetype-text hershey-text image-io"
        
      - name: Run Check f64 parallel earcut
        run: cargo check --no-default-features --features
          "f64 earcut parallel stl-io svg-io dxf-io truetype-text hershey-text image-io"
          
      - name: Run Check f64 single threaded delaunay
        run: cargo check --no-default-features --features
          "f64 delaunay stl-io svg-io dxf-io truetype-text hershey-text image-io"
        
      - name: Run Check f64 parallel delaunay
        run: cargo check --no-default-features --features
          "f64 delaunay parallel stl-io svg-io dxf-io truetype-text hershey-text image-io"

  test:
    name: Test Suite
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Rust/Cargo Cache
        uses: Swatinem/rust-cache@v2
          
      - name: Run Test f32 single threaded earcut
        run: cargo test --lib --no-default-features --features
          "f32 earcut stl-io svg-io dxf-io truetype-text hershey-text image-io"
        
      - name: Run Test f32 parallel earcut
        run: cargo test --lib --no-default-features --features
          "f32 earcut parallel stl-io svg-io dxf-io truetype-text hershey-text image-io"
          
      - name: Run Test f32 single threaded delaunay
        run: cargo test --lib --no-default-features --features
          "f32 delaunay stl-io svg-io dxf-io truetype-text hershey-text image-io"
        
      - name: Run Test f32 parallel delaunay
        run: cargo test --lib --no-default-features --features
          "f32 delaunay parallel stl-io svg-io dxf-io truetype-text hershey-text image-io"
          
      - name: Run Test f64 single threaded earcut
        run: cargo test --lib --no-default-features --features
          "f64 earcut stl-io svg-io dxf-io truetype-text hershey-text image-io"
        
      - name: Run Test f64 parallel earcut
        run: cargo test --lib --no-default-features --features
          "f64 earcut parallel stl-io svg-io dxf-io truetype-text hershey-text image-io"
          
      - name: Run Test f64 single threaded delaunay
        run: cargo test --lib --no-default-features --features
          "f64 delaunay stl-io svg-io dxf-io truetype-text hershey-text image-io"
        
      - name: Run Test f64 parallel delaunay
        run: cargo test --lib --no-default-features --features
          "f64 delaunay parallel stl-io svg-io dxf-io truetype-text hershey-text image-io"

  fmt:
    name: Formatting
    runs-on: ubuntu-latest
    continue-on-error: true
    steps:
      - uses: actions/checkout@v4

      - name: Run Fmt
        run: cargo fmt --all -- --check

  clippy:
    name: Clippy
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Rust/Cargo Cache
        uses: Swatinem/rust-cache@v2

      - name: Run Clippy
        run: cargo clippy --lib --no-default-features --features
          "f32 earcut parallel stl-io svg-io dxf-io truetype-text hershey-text image-io"
          -- -D warnings

  style:
    name: Check spelling and semver
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Remove untracked files
        run: git clean -df

      - name: Rust/Cargo Cache
        uses: Swatinem/rust-cache@v2

      - name: Check semver
        uses: obi1kenobi/cargo-semver-checks-action@v2
        with:
          package: csgrs
          no-default-features: true
          features: |
            f32
            earcut
            parallel
            stl-io
            svg-io
            dxf-io
            truetype-text
            hershey-text
            image-io
      - name: Check spelling
        run: |
          if ! command -v typos >/dev/null; then
            cargo install typos-cli
          fi
          typos
